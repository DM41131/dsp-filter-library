{"version":3,"file":"fir.js","sources":["../src/fir.js"],"sourcesContent":["// fir.js â€” Finite Impulse Response filter design\r\n// Author: Davit Akobia <dav.akobia@gmail.com>\r\n// License: MIT\r\n\r\nimport { ComplexNum as C } from './complex.js';\r\nimport { Util } from './utils.js';\r\nimport { FFT } from './fft.js';\r\nimport { Window } from './windows.js';\r\n\r\n/**\r\n * @typedef {\"lowpass\"|\"highpass\"|\"bandpass\"|\"bandstop\"} FiltKind\r\n * @typedef {{b:number[], a:number[]}} TF\r\n */\r\n\r\n/**\r\n * FIR filter kernels and design functions\r\n */\r\nexport class Kernels {\r\n    static sinc(x) { \r\n        return x === 0 ? 1 : Math.sin(Math.PI * x) / (Math.PI * x); \r\n    }\r\n    \r\n    static idealLowpass(fc, fs, N) {\r\n        const M = N - 1, norm = fc / fs;\r\n        return Array.from({ length: N }, (_, n) => Kernels.sinc((n - M/2) * 2 * norm));\r\n    }\r\n}\r\n\r\n/**\r\n * FIR filter designer\r\n */\r\nexport class FIRDesigner {\r\n    /**\r\n     * @param {FiltKind} kind\r\n     * @param {number|[number,number]} cutoffHz\r\n     * @param {number} fs\r\n     * @param {number} order\r\n     * @param {string} window\r\n     * @returns {TF}\r\n     */\r\n    static design(kind, cutoffHz, fs, order, window = 'hann') {\r\n        const N = order + 1;\r\n        const win = Window.byName(window, N);\r\n        const M = N - 1;\r\n        const applyWin = (h) => h.map((v, i) => v * win[i]);\r\n\r\n        if (kind === 'lowpass') {\r\n            const fc = /** @type {number} */(cutoffHz);\r\n            let h = Kernels.idealLowpass(fc, fs, N);\r\n            const scale = 2 * fc / fs;\r\n            h = h.map(v => v * scale);\r\n            return { b: applyWin(h), a: [1] };\r\n        }\r\n        if (kind === 'highpass') {\r\n            const fc = /** @type {number} */(cutoffHz);\r\n            const lp = FIRDesigner.design('lowpass', fc, fs, order, window).b;\r\n            const b = lp.map((v, n) => (n === M/2 ? 1 - v : -v));\r\n            return { b, a: [1] };\r\n        }\r\n        if (kind === 'bandpass') {\r\n            const [f1, f2] = /** @type {[number,number]} */(cutoffHz);\r\n            const lp2 = FIRDesigner.design('lowpass', f2, fs, order, window).b;\r\n            const lp1 = FIRDesigner.design('lowpass', f1, fs, order, window).b;\r\n            const b = lp2.map((v, i) => v - lp1[i]);\r\n            return { b, a: [1] };\r\n        }\r\n        if (kind === 'bandstop') {\r\n            const [f1, f2] = /** @type {[number,number]} */(cutoffHz);\r\n            const bp = FIRDesigner.design('bandpass', [f1, f2], fs, order, window).b;\r\n            const b = bp.map((v, n) => (n === M/2 ? 1 - v : -v));\r\n            return { b, a: [1] };\r\n        }\r\n        throw new Error('Unsupported FIR type');\r\n    }\r\n\r\n    static apply(b, x) { \r\n        return Util.convolve(x, b); \r\n    }\r\n\r\n    static overlapAdd(b, x, blockSize) {\r\n        const L = blockSize || 1024;\r\n        const M = b.length;\r\n        const Nfft = Util.nextPow2(L + M - 1);\r\n        const B = FFT.fft(Array.from({ length: Nfft }, (_, i) => C.of(b[i] || 0, 0)));\r\n        const y = new Array(x.length + M - 1).fill(0);\r\n        for (let start = 0; start < x.length; start += L) {\r\n            const xblk = Array.from({ length: Nfft }, (_, i) => C.of(x[start + i] || 0, 0));\r\n            const X = FFT.fft(xblk);\r\n            const Y = X.map((Xk, k) => C.mul(Xk, B[k]));\r\n            const yblk = FFT.ifft(Y);\r\n            for (let i = 0; i < L + M - 1; i++) y[start + i] += yblk[i].re;\r\n        }\r\n        return y;\r\n    }\r\n}\r\n"],"names":["C"],"mappings":"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"}