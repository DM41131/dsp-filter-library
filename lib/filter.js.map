{"version":3,"file":"filter.js","sources":["../src/filter-class.js"],"sourcesContent":["// filter-class.js â€” Main Filter class and operations\r\n// License: MIT\r\n\r\nimport { ComplexNum as C } from './complex.js';\r\nimport { FIRDesigner } from './fir.js';\r\nimport { IIRDesigner } from './iir.js';\r\nimport { ZDomain } from './zdomain.js';\r\n\r\nexport class Filter {\r\n    constructor(b, a = [1], sections = []) {\r\n        if (Math.abs(a[0] - 1) > 1e-12) {\r\n            b = b.map(v => v / a[0]);\r\n            a = a.map(v => v / a[0]);\r\n        }\r\n        this.b = b.slice();\r\n        this.a = a.slice();\r\n        this.sections = (sections || []).map(s => ({ b: s.b.slice(), a: [1, s.a[1], s.a[2]] }));\r\n\r\n        if (this.sections.length > 0) {\r\n            this._sosState = this.sections.map(() => ({ w1: 0, w2: 0 }));\r\n        } else if (this.a.length === 1) {\r\n            this._firIdx = 0;\r\n            this._firBuf = new Array(this.b.length).fill(0);\r\n        } else {\r\n            const N = Math.max(this.b.length, this.a.length) - 1;\r\n            this._iirW = new Array(N).fill(0);\r\n        }\r\n    }\r\n\r\n    reset() {\r\n        if (this._sosState) this._sosState.forEach(s => { s.w1 = 0; s.w2 = 0; });\r\n        if (this._firBuf) this._firBuf.fill(0), this._firIdx = 0;\r\n        if (this._iirW) this._iirW.fill(0);\r\n    }\r\n\r\n    processSample(x) {\r\n        if (this.sections.length > 0) {\r\n            let v = x;\r\n            for (let i = 0; i < this.sections.length; i++) {\r\n                const { b, a } = this.sections[i];\r\n                const st = this._sosState[i];\r\n                const w0 = v - a[1]*st.w1 - a[2]*st.w2;\r\n                const y0 = b[0]*w0 + b[1]*st.w1 + b[2]*st.w2;\r\n                st.w2 = st.w1; st.w1 = w0;\r\n                v = y0;\r\n            }\r\n            return v;\r\n        }\r\n\r\n        if (this.a.length === 1) {\r\n            this._firBuf[this._firIdx] = x;\r\n            let y = 0, idx = this._firIdx;\r\n            for (let k = 0; k < this.b.length; k++) {\r\n                y += this.b[k] * this._firBuf[idx];\r\n                idx = (idx - 1 + this._firBuf.length) % this._firBuf.length;\r\n            }\r\n            this._firIdx = (this._firIdx + 1) % this._firBuf.length;\r\n            return y;\r\n        }\r\n\r\n        let wn = x;\r\n        for (let k = 1; k < this.a.length; k++) wn -= this.a[k] * (this._iirW[k-1] || 0);\r\n        let yn = this.b[0]*wn;\r\n        for (let k = 1; k < this.b.length; k++) yn += (this._iirW[k-1] || 0) * this.b[k];\r\n        for (let k = this._iirW.length-1; k > 0; k--) this._iirW[k] = this._iirW[k-1];\r\n        this._iirW[0] = wn;\r\n        return yn;\r\n    }\r\n\r\n    applySignal(x) {\r\n        const y = new Array(x.length);\r\n        for (let i=0;i<x.length;i++) y[i] = this.processSample(x[i]);\r\n        return y;\r\n    }\r\n\r\n    frequencyResponse(fs, N = 1024) {\r\n        const fr = ZDomain.freqz(this.b, this.a, N);\r\n        const f = fr.w.map(w => w * fs / (2*Math.PI));\r\n        return { f, mag: fr.mag, phase: fr.phase, H: fr.H };\r\n    }\r\n\r\n    toJSON(){ \r\n        return { b: this.b.slice(), a: this.a.slice() }; \r\n    }\r\n\r\n    static fromTF(b,a){ \r\n        return new Filter(b,a); \r\n    }\r\n    \r\n    static designFIR(kind, cutoffHz, fs, order, window='hann'){\r\n        const tf = FIRDesigner.design(kind, cutoffHz, fs, order, window);\r\n        return new Filter(tf.b, tf.a);\r\n    }\r\n    \r\n    static designButter(kind, cutoffHz, fs, order){\r\n        const result = IIRDesigner.butterworth(kind, cutoffHz, fs, order);\r\n        return new Filter(result.b, result.a, result.sections);\r\n    }\r\n    \r\n    static designCheby1(kind, cutoffHz, fs, order, rp=1){\r\n        const result = IIRDesigner.cheby1(kind, cutoffHz, fs, order, rp);\r\n        return new Filter(result.b, result.a, result.sections);\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}