!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).DSPFilterLibrary={})}(this,function(e){"use strict";class t{static add(e,t){return{re:e.re+t.re,im:e.im+t.im}}static sub(e,t){return{re:e.re-t.re,im:e.im-t.im}}static mul(e,t){return{re:e.re*t.re-e.im*t.im,im:e.re*t.im+e.im*t.re}}static div(e,t){const r=t.re*t.re+t.im*t.im||1e-300;return{re:(e.re*t.re+e.im*t.im)/r,im:(e.im*t.re-e.re*t.im)/r}}static abs(e){return Math.hypot(e.re,e.im)}static conj(e){return{re:e.re,im:-e.im}}}const r=2*Math.PI;function s(e,t,r){const s=new Array(r),i=(t-e)/(r-1);for(let t=0;t<r;t++)s[t]=e+t*i;return s}function i(e){const t=[...e];for(let e=0;e<2;e++)for(let e=1;e<t.length;e++){const s=t[e]-t[e-1];s>Math.PI&&(t[e]-=r),s<-Math.PI&&(t[e]+=r)}return t}class n{static evalRealAsc(e,r){let s={re:e[0],im:0};for(let i=1;i<e.length;i++)s=t.add(t.mul(s,r),{re:e[i],im:0});return s}}function o(e,r){const s=e.length-1;let i={re:1,im:0},n={re:0,im:0};for(let o=1;o<=s;o++)n=t.add(t.mul(n,r),i),i=t.add(t.mul(i,r),{re:e[o],im:0});return{p:i,dp:n}}class a{static aberthMonic(e){let r=0;for(;r<e.length-1&&Math.abs(e[r])<1e-18;)r++;let s=e.slice(r);const i=s.length-1;if(i<=0)return[];const n=s[0];s=s.map(e=>e/n);let a=0;for(let e=1;e<s.length;e++)a=Math.max(a,Math.abs(s[e]));const c=Math.max(.5,Math.min(1.5,1+a)),h=new Array(i);for(let e=0;e<i;e++){const t=2*Math.PI*(e+.5)/i,r=1+.001*(e%2?1:-1);h[e]={re:c*r*Math.cos(t),im:c*r*Math.sin(t)}}const l=1e-14;for(let e=0;e<200;e++){let e=!1;for(let r=0;r<i;r++){const n=h[r],{p:a,dp:c}=o(s,n);let m={re:0,im:0};for(let e=0;e<i;e++)if(e!==r){let r=t.sub(n,h[e]);const s=r.re*r.re+r.im*r.im;s<1e-28&&(r={re:r.re+l,im:r.im});const i={re:r.re/(s||1e-300),im:-r.im/(s||1e-300)};m=t.add(m,i)}const u=t.sub(c,t.mul(a,m)),f=t.div(a,u),p=t.sub(n,f);Math.hypot(p.re-n.re,p.im-n.im)>1e-12&&(e=!0),h[r]=p}if(!e)break}return h}static dkScaled(e){let r=0;for(;r<e.length-1&&Math.abs(e[r])<1e-18;)r++;const s=e.slice(r),i=s.length-1;if(i<=0)return[];const o=s[0],a=s.map(e=>e/o),c=[];for(const e of[.8,1.1,1.5]){const r=new Array(i);for(let t=0;t<i;t++){const s=2*Math.PI*(t+1)/i;r[t]={re:e*Math.cos(s),im:e*Math.sin(s)}}for(let e=0;e<200;e++){let e=!1;for(let s=0;s<i;s++){let o={re:1,im:0};for(let e=0;e<i;e++)s!==e&&(o=t.mul(o,t.sub(r[s],r[e])));const c=n.evalRealAsc(a,r[s]),h=t.div(c,o),l=t.sub(r[s],h);Math.hypot(l.re-r[s].re,l.im-r[s].im)>1e-12&&(e=!0),r[s]=l}if(!e)break}c.push(...r)}return c}}class c{static butter(e){const t=[];for(let r=1;r<=e;r++){const s=(2*r-1)*Math.PI/(2*e);t.push({re:-Math.sin(s),im:Math.cos(s)})}return{poles:t,zeros:[]}}static cheby1(e,t){const r=Math.sqrt(Math.pow(10,t/10)-1),s=Math.asinh(1/r)/e,i=[];for(let t=1;t<=e;t++){const r=(2*t-1)*Math.PI/(2*e);i.push({re:-Math.sinh(s)*Math.sin(r),im:Math.cosh(s)*Math.cos(r)})}return{poles:i,zeros:[]}}static cheby2(e,t){const r=1/Math.sqrt(Math.pow(10,t/10)-1),s=Math.asinh(1/r)/e,i=[],n=[];for(let t=1;t<=e;t++){const r=(2*t-1)*Math.PI/(2*e);i.push({re:-Math.sinh(s)*Math.sin(r),im:Math.cosh(s)*Math.cos(r)})}const o=Math.floor(e/2);for(let t=1;t<=o;t++){const r=(2*t-1)*Math.PI/(2*e),s=1/Math.cos(r);n.push({re:0,im:s},{re:0,im:-s})}return{poles:i,zeros:n}}static ellipHybrid(e,t,r){const s=c.cheby1(e,t),i=c.cheby2(e,r);return{poles:s.poles,zeros:i.zeros}}static linkwitzRiley(e){const t=e%2==0?e:e+1,r=c.butter(t/2),s=[];return r.poles.forEach(e=>{s.push(e,{re:e.re,im:e.im})}),{poles:s,zeros:[],enforcedOrder:t}}static bessel(e){const t=Math.min(e,12),r=new Array(t+1).fill(0);r[0]=1;for(let e=1;e<=t;e++)r[e]=r[e-1]*((t+e)*(t-e+1))/(2*e);return{poles:(()=>{const e=r.length-1,t=new Array(e);for(let r=0;r<e;r++){const s=2*Math.PI*(r+1)/e;t[r]={re:1.5*Math.cos(s),im:1.5*Math.sin(s)}}for(let s=0;s<200;s++){let s=!1;for(let i=0;i<e;i++){let o={re:1,im:0};for(let r=0;r<e;r++)i!==r&&(o={re:o.re*(t[i].re-t[r].re)-o.im*(t[i].im-t[r].im),im:o.re*(t[i].im-t[r].im)+o.im*(t[i].re-t[r].re)});const a=n.evalRealAsc(r,t[i]),c={re:a.re/(o.re||1e-300),im:a.im/(o.re||1e-300)},h={re:t[i].re-c.re,im:t[i].im-c.im};Math.hypot(h.re-t[i].re,h.im-t[i].im)>1e-12&&(s=!0),t[i]=h}if(!s)break}return t.filter(e=>e.re<0||Math.abs(e.re)<1e-12)})(),zeros:[]}}}class h{static prewarp(e,t){return 2*t*Math.tan(Math.PI*e/t)}static sToZ(e,r){const s={re:2*r+e.re,im:e.im},i={re:2*r-e.re,im:-e.im};return t.div(s,i)}static quad(e,r,s){const i=t.mul(r,r),n=t.mul({re:4,im:0},t.mul(e,s)),o=function(e){const t=e.re,r=e.im,s=Math.hypot(t,r),i=Math.sqrt((s+Math.abs(t))/2);if(t>=0)return{re:i,im:r/(2*(i||1e-300))};const n=(r>=0?1:-1)*i;return{re:r/(2*(n||1e-300)),im:n}}({re:i.re-n.re,im:i.im-n.im}),a={re:-r.re,im:-r.im},c=t.mul({re:2,im:0},e);return[t.div(t.add(a,o),c),t.div(t.sub(a,o),c)]}}function l(e){const t=new Array(e.length).fill(!1),r=[];for(let s=0;s<e.length;s++){if(t[s])continue;const i=e[s];let n=!1;for(let o=s+1;o<e.length;o++)if(!t[o]){const a=e[o];if(Math.abs(i.re-a.re)<1e-10&&Math.abs(i.im+a.im)<1e-10){r.push([i,a]),t[s]=t[o]=!0,n=!0;break}}n||(r.push([i]),t[s]=!0)}return r}class m{static fromZPK(e,r,s=1){for(;e.length<r.length;)e.push({re:-1,im:0});const i=l(e),n=l(r),o=[];let a=0,c=0;for(;c<n.length;){const e=n[c++],r=a<i.length?i[a++]:[{re:-1,im:0},{re:-1,im:0}],s=e[0],h=e[1]||{re:0,im:0},l=r[0],m=r[1]||{re:-1,im:0},u={re:l.re+m.re,im:l.im+m.im},f=t.mul(l,m),p={re:s.re+h.re,im:s.im+h.im},M=t.mul(s,h),b=[1,-u.re,f.re],g=[1,-p.re,M.re];o.push({b:b,a:g})}return o.length&&(o[0].b=[o[0].b[0]*s,o[0].b[1]*s,o[0].b[2]*s]),o}}class u{static H_w_IIR(e,r){const s=Math.cos(r),i=-Math.sin(r),n=Math.cos(2*r),o=-Math.sin(2*r);let a={re:1,im:0};for(const r of e){const[e,c,h]=r.b,[,l,m]=r.a,u={re:e+c*s+h*n,im:c*i+h*o},f={re:1+l*s+m*n,im:l*i+m*o},p=f.re*f.re+f.im*f.im,M={re:(u.re*f.re+u.im*f.im)/p,im:(u.im*f.re-u.re*f.im)/p};a=t.mul(a,M)}return a}static H_w_FIR(e,t){let r=0,s=0;for(let i=0;i<e.length;i++)r+=e[i]*Math.cos(t*i),s-=e[i]*Math.sin(t*i);return{re:r,im:s}}static magDbFromH(e){return 20*Math.log10(Math.max(1e-16,t.abs(e)))}static unwrapToDeg(e){return i(e).map(e=>180*e/Math.PI)}static groupDelay(e,t){const r=t.length,s=new Array(r).fill(0);if(r>=3){for(let i=1;i<r-1;i++){const r=e[i+1]-e[i-1],n=t[i+1]-t[i-1];s[i]=-r/(n||1e-12)}s[0]=s[1],s[r-1]=s[r-2]}return s}static phaseDelay(e,t){const r=new Array(t.length).fill(0);for(let s=0;s<t.length;s++)r[s]=0===t[s]?NaN:-e[s]/t[s];let s=r.find(e=>Number.isFinite(e));Number.isFinite(s)||(s=0);for(let e=0;e<r.length&&!Number.isFinite(r[e]);e++)r[e]=s;for(let e=1;e<r.length;e++)Number.isFinite(r[e])||(r[e]=r[e-1]);return r}}class f{static rect(e){return Array.from({length:e},()=>1)}static hann(e){return Array.from({length:e},(t,r)=>.5*(1-Math.cos(2*Math.PI*r/(e-1))))}static hamming(e){return Array.from({length:e},(t,r)=>.54-.46*Math.cos(2*Math.PI*r/(e-1)))}static blackman(e){return Array.from({length:e},(t,r)=>.42-.5*Math.cos(2*Math.PI*r/(e-1))+.08*Math.cos(4*Math.PI*r/(e-1)))}static kaiser(e,t){const r=e=>{let t=1,r=1,s=1;const i=e/2*(e/2);for(;s<32&&(r*=i/(s*s),t+=r,!(r<1e-12));s++);return t},s=r(t),i=new Array(e);for(let n=0;n<e;n++){const o=2*n/(e-1)-1;i[n]=r(t*Math.sqrt(1-o*o))/s}return i}static byName(e,t,r=6){switch(e){case"rect":return f.rect(t);case"hann":return f.hann(t);case"hamming":default:return f.hamming(t);case"blackman":return f.blackman(t);case"kaiser":return f.kaiser(t,r)}}}function p(e,t,r=1e-9){for(const s of e)if(Math.hypot(s.re-t.re,s.im-t.im)<r)return!1;return e.push(t),!0}class M{static fromTapsRobust(e){const t=e.length-1,r=new Array(e.length);for(let s=0;s<e.length;s++)r[s]=e[t-s];let s=0;for(;s<r.length-1&&Math.abs(r[s])<1e-18;)s++;const i=r.slice(s).length-1;if(i<=0)return[];const n=[];try{for(const e of a.aberthMonic(r))Number.isFinite(e.re)&&Number.isFinite(e.im)&&p(n,e)}catch{}try{for(const e of a.dkScaled(r))Number.isFinite(e.re)&&Number.isFinite(e.im)&&p(n,e)}catch{}if(n.length<i){const t=function(e,t){const r=8192,s=[],i=new Float64Array(r+1);for(let t=0;t<=r;t++){const s=Math.PI*t/r,n=u.H_w_FIR(e,s);i[t]=Math.hypot(n.re,n.im)}for(let e=1;e<r;e++)if(i[e]<i[e-1]&&i[e]<i[e+1]){const i=Math.PI*e/r;if(s.push({re:Math.cos(i),im:Math.sin(i)}),s.length>=t)break}return s}(e,i-n.length);for(const e of t)p(n,e,1e-6)}const o=function(e,t=1e-9){const r=[];for(const s of e)p(r,s,t),Math.abs(s.im)>1e-12&&p(r,{re:s.re,im:-s.im},t);return r}(n),c=[];for(const e of o)if(p(c,e,1e-9)&&c.length===i)break;return c.length>i?c.slice(0,i):c}}class b{constructor(e){this.init=e,this._zeros=null}get type(){return"FIR"}get taps(){return this.init.taps}get Fs(){return this.init.Fs}impulseResponse(e=256){return this.taps.slice(0,e)}zeros(){return this._zeros||(this._zeros=M.fromTapsRobust(this.taps)),this._zeros}frequencyGrid(e=1024){const t=s(0,Math.PI,e),r=[],n=[];for(const e of t){const t=u.H_w_FIR(this.taps,e);r.push(u.magDbFromH(t)),n.push(Math.atan2(t.im,t.re))}const o=i(n),a=u.groupDelay(o,t),c=u.phaseDelay(o,t),h=t.map(e=>e/Math.PI*(this.Fs/2));return{w:t,freqHz:h,magdB:r,phaseDeg:o.map(e=>180*e/Math.PI),gdSamples:a,pdSamples:c}}}function g(e){return 0===e?1:Math.sin(Math.PI*e)/(Math.PI*e)}class d{constructor(e){this.spec=e}design(){const{kind:e,taps:t,Fs:r,f1:s,f2:i=s,window:n="hamming",beta:o=6}=this.spec,a=(t-1)/2,c=2*Math.PI*(s/r),h=2*Math.PI*(i/r),l=f.byName(n,t,o),m=new Array(t).fill(0),p=e=>{const r=new Array(t);for(let s=0;s<t;s++)r[s]=2*e/(2*Math.PI)*g((s-a)*e/Math.PI);return r};if("lowpass"===e){const e=p(c);for(let r=0;r<t;r++)m[r]=e[r]*l[r]}else if("highpass"===e){const e=p(c);for(let r=0;r<t;r++){const t=r===a?1:0;m[r]=(t-e[r])*l[r]}}else if("bandpass"===e){const e=p(h),r=p(c);for(let s=0;s<t;s++)m[s]=(e[s]-r[s])*l[s]}else{const e=p(h),r=p(c);for(let s=0;s<t;s++){const t=s===a?1:0;m[s]=(t-(e[s]-r[s]))*l[s]}}let M=0;if("highpass"===e&&(M=Math.PI),"bandpass"===e){const e=Math.sqrt(s*i);M=2*Math.PI*(e/r)}const d=u.H_w_FIR(m,M),y=1/(Math.hypot(d.re,d.im)||1e-12);for(let e=0;e<t;e++)m[e]*=y;return new b({taps:m,Fs:r})}}class y{constructor(e){this.init=e}get type(){return"IIR"}get sections(){return this.init.sections}get Fs(){return this.init.Fs}get zPoles(){return this.init.zPoles}get zZeros(){return this.init.zZeros}impulseResponse(e=256){const t=new Array(e).fill(0);t[0]=1;let r=t.slice();for(const t of this.sections){const[s,i,n]=t.b,[,o,a]=t.a,c=new Array(e).fill(0);let h=0,l=0;for(let t=0;t<e;t++){const e=r[t]-o*h-a*l,m=s*e+i*h+n*l;c[t]=m,l=h,h=e}r=c}return r}frequencyGrid(e=1024){const t=s(0,Math.PI,e),r=[],n=[];for(const e of t){const t=u.H_w_IIR(this.sections,e);r.push(u.magDbFromH(t)),n.push(Math.atan2(t.im,t.re))}const o=i(n),a=u.groupDelay(o,t),c=u.phaseDelay(o,t),h=t.map(e=>e/Math.PI*(this.Fs/2));return{w:t,freqHz:h,magdB:r,phaseDeg:o.map(e=>180*e/Math.PI),gdSamples:a,pdSamples:c}}}function I(e,t){const r=t.re*t.re+t.im*t.im||1e-300;return{re:(e.re*t.re+0*t.im)/r,im:(0*t.re-e.re*t.im)/r}}class w{constructor(e){this.spec=e}design(){const{family:e,kind:t,Fs:r}=this.spec;let{N:s,f1:i,f2:n}=this.spec;const o=this.spec.Rp??1,a=this.spec.Rs??60;let l;switch(e){case"butter":default:l=c.butter(s);break;case"cheby1":l=c.cheby1(s,o);break;case"cheby2":l=c.cheby2(s,a);break;case"ellip":l=c.ellipHybrid(s,o,a);break;case"linkwitz":{const e=c.linkwitzRiley(s);s=e.enforcedOrder??s,l={poles:e.poles,zeros:[]};break}case"bessel":l=c.bessel(s)}l.family=e,l.order=s;let f=[],p=[];if("lowpass"===t||"highpass"===t){const n=h.prewarp(i,r),o=l.poles.map(e=>"lowpass"===t?{re:e.re*n,im:e.im*n}:I({re:n},e)),a=l.zeros.map(e=>"lowpass"===t?{re:e.re*n,im:e.im*n}:I({re:n},e));if(f=o.map(e=>h.sToZ(e,r)),p=a.map(e=>h.sToZ(e,r)),["butter","cheby1","bessel","linkwitz"].includes(e)&&"highpass"===t)for(let e=0;e<s;e++)p.push({re:1,im:0})}else{if(!n)throw new Error("bandpass/bandstop require f2");if(n<i){const e=i;i=n,n=e}const o=h.prewarp(i,r),a=h.prewarp(n,r),c=a-o,m=Math.sqrt(o*a),u=[],M=[];if("bandpass"===t){for(const e of l.poles){const[t,r]=h.quad({re:1,im:0},{re:-e.re*c,im:-e.im*c},{re:m*m,im:0});u.push(t,r)}for(const e of l.zeros){const[t,r]=h.quad({re:1,im:0},{re:-e.re*c,im:-e.im*c},{re:m*m,im:0});M.push(t,r)}if(["butter","cheby1","bessel","linkwitz"].includes(e))for(let e=0;e<s;e++)M.push({re:0,im:0});if(f=u.map(e=>h.sToZ(e,r)),p=M.map(e=>h.sToZ(e,r)),["butter","cheby1","bessel","linkwitz"].includes(e))for(let e=0;e<s;e++)p.push({re:-1,im:0});else"cheby2"===e&&s%2==1&&p.push({re:1,im:0},{re:-1,im:0})}else{for(const e of l.poles){const[t,r]=h.quad({re:e.re,im:e.im},{re:-c,im:0},{re:e.re*m*m,im:e.im*m*m});u.push(t,r)}for(const e of l.zeros){const[t,r]=h.quad({re:e.re,im:e.im},{re:-c,im:0},{re:e.re*m*m,im:e.im*m*m});M.push(t,r)}for(let e=0;e<s;e++)M.push({re:0,im:m},{re:0,im:-m});f=u.map(e=>h.sToZ(e,r)),p=M.map(e=>h.sToZ(e,r))}}const M=m.fromZPK(p,f,1);let b=0;if("highpass"===t&&(b=Math.PI),"bandpass"===t){const e=Math.sqrt(i*n);b=2*Math.PI*(e/r)}const g=u.H_w_IIR(M,b),d=1/(Math.hypot(g.re,g.im)||1e-12);return M[0].b=[M[0].b[0]*d,M[0].b[1]*d,M[0].b[2]*d],new y({sections:M,Fs:r,zPoles:f,zZeros:p})}}e.BLT=h,e.Cx=t,e.FIRDesigner=d,e.FIRFilter=b,e.FIRZeros=M,e.FilterDSP=class{static designFIR(e){return new d(e).design()}static designIIR(e){return new w(e).design()}},e.IIRDesigner=w,e.IIRFilter=y,e.Poly=n,e.Prototypes=c,e.Response=u,e.Roots=a,e.SOS=m,e.TAU=r,e.Windows=f,e.linspace=s,e.unwrapPhase=i});
//# sourceMappingURL=dsp-filter-library.min.js.map
